{% extends "base.html" %}

{% block title %}Data Visualization - Exoplings{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">üìä Light Curve Visualization</h3>
                <p class="mb-0 mt-1">{{ data_info.filename }}</p>
            </div>
            <div class="card-body">
                <div id="plotly-chart"></div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h3 class="mb-0">üìä Inference Visualization Plots</h3>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <div class="d-flex align-items-center mb-2">
                        <span class="me-2" style="font-size:1.3rem;">ü™ê</span>
                        <h5 class="mb-0 fw-semibold text-primary">Posterior on Planet Radius</h5>
                    </div>
                    <div id="plotly-posterior-chart"></div>
                </div>
                <div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="me-2" style="font-size:1.3rem;">üìà</span>
                        <h5 class="mb-0 fw-semibold text-primary">Highest Probability Light Curve Model</h5>
                    </div>
                    {% if posterior_lc_plot_json %}
                    <div id="plotly-posterior-lc-chart"></div>
                    {% else %}
                    <p class="text-muted">Plot Unavailable</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h3 class="mb-0">üìä Multi Dimensional Inference</h3>
            </div>
            <div class="card-body">
                {% if corner_plot_json %}
                    <div id="plotly-corner-chart"></div>
                {% else %}
                    <p class="text-muted">Plot Unavailable</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìã Data Summary</h5>
            </div>
            <div class="card-body">                
                <div class="mb-3">
                    <h6>Is it an exoplanet?</h6>
                    <p>
                        {% if exoplanet_result is defined and exoplanet_result %}
                            {% if exoplanet_result.is_exoplanet %}
                                <span class="fw-bold text-success">‚úÖ This light curve is likely from an exoplanet candidate.</span><br>
                                Estimated certainty: <span class="fw-bold">{{ ('%.2f' % (exoplanet_result.certainty * 100)) }}%</span>
                            {% else %}
                                <span class="fw-bold text-danger">‚ùå This light curve does not appear to be from an exoplanet.</span><br>
                                Estimated certainty: <span class="fw-bold">{{ ('%.2f' % (exoplanet_result.certainty * 100)) }}%</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Exoplanet classification information is not available for this dataset.</span>
                        {% endif %}
                        <br>
                        Processing Time (CPU): <span class="fw-bold">{{ processing_time }}ms</span><br>
                    </p>
                </div>
                
                
                <div class="d-grid gap-2">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                        üìÅ Upload New File
                    </a>
                    <a href="{{ url_for('visualize', filename_or_id=['432549364', '308098254', '436875934', '259506033', '281541545'] | random) }}"
                        class="btn btn-outline-secondary"
                        id="pick-random-btn">
                         ü™ê Pick Random TESS Planet
                    </a>
                    <script>
                        document.getElementById('pick-random-btn').addEventListener('click', function(e) {
                            // Show loading modal
                            var modal = new bootstrap.Modal(document.getElementById('loadingModal'));
                            modal.show();
                        });
                </script>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">üéõÔ∏è Visualization Controls</h6>
            </div>
            <div class="card-body">
                <p class="small text-muted">
                    <strong>Interaction Tips:</strong><br>
                    ‚Ä¢ Click and drag to zoom<br>
                    ‚Ä¢ Double-click to reset zoom<br>
                    ‚Ä¢ Hover for detailed information<br>
                    ‚Ä¢ Use toolbar for more options
                </p>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
            <h6 class="mb-0">üïë Recently Uploaded Files</h6>
            </div>
            <div class="card-body">
            {% if most_recent_curves and most_recent_curves|length > 0 %}
                <div class="row g-3">
                    {% for curve in most_recent_curves[:10] %}
                        <div class="col-12">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-body py-3 d-flex align-items-center">
                                    <span class="me-2" style="font-size:1rem;">üìÑ</span>
                                    <a href="{{ url_for('visualize', filename_or_id=curve) }}" class="fw-bold text-primary text-decoration-none">
                                        {{ curve }}
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    </div>
            {% else %}
                <p class="text-muted mb-0">No recent files available.</p>
            {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Plotly.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/3.1.0/plotly.min.js"></script>

<script>
// Render the Plotly chart
document.addEventListener('DOMContentLoaded', function() {
    {% if posterior_lc_plot_json %}
    const posterior_lc_plot_data = {{ posterior_lc_plot_json|safe }};
    {% else %}
    const posterior_lc_plot_data = null;
    {% endif %}

    const light_curve_plot_data = {{ light_curve_plot_json|safe }};
    const posterior_plot_data = {{ posterior_plot_json|safe }};
    const corner_plot_data = {{ corner_plot_json|safe }};

    // Configuration for the plot
    const light_curve_configs = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
        displaylogo: false,
        toImageButtonOptions: {
            format: 'png',
            filename: '{{ data_info.filename }}_plot',
            height: 600,
            width: 800,
            scale: 2
        }
    };

    const posterior_configs = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
        displaylogo: false,
        toImageButtonOptions: {
            format: 'png',
            filename: '{{ data_info.filename }}_plot',
            height: 600,
            width: 800,
            scale: 2
        }
    };

    const posterior_lc_configs = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
        displaylogo: false,
        toImageButtonOptions: {
            format: 'png',
            filename: '{{ data_info.filename }}_plot',
            height: 600,
            width: 800,
            scale: 2
        }
    };

    const corner_configs = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
        displaylogo: false,
        toImageButtonOptions: {
            format: 'png',
            filename: '{{ data_info.filename }}_plot',
            height: 600,
            width: 800,
            scale: 2
        }
    };
    
    // Layout updates
    const light_curve_layout = {
        ...light_curve_plot_data.layout,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {
            family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
            size: 12
        }
    };

    const posterior_layout = {
        ...posterior_plot_data.layout,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {
            family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
            size: 12
        }
    };

    const corner_layout = {
        ...corner_plot_data.layout,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {
            family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
            size: 12
        }
    };

    var posterior_lc_layout = null;
    if (posterior_lc_plot_data) {
        posterior_lc_layout = {
            ...posterior_lc_plot_data.layout,
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: {
                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                size: 12
            }
        };
    }
    
    // Render the plot
    Plotly.newPlot('plotly-chart', light_curve_plot_data.data, light_curve_layout, light_curve_configs);
    Plotly.newPlot('plotly-posterior-chart', posterior_plot_data.data, posterior_layout, posterior_configs);
    Plotly.newPlot('plotly-corner-chart', corner_plot_data.data, corner_layout, corner_configs);

    if (posterior_lc_plot_data) {
        Plotly.newPlot('plotly-posterior-lc-chart', posterior_lc_plot_data.data, posterior_lc_layout, posterior_lc_configs);
    }

    // Handle window resize
    window.addEventListener('resize', function() {
        Plotly.Plots.resize('plotly-posterior-chart');
        Plotly.Plots.resize('plotly-chart');
        Plotly.Plots.resize('plotly-corner-chart');
        if (posterior_lc_plot_data)
            Plotly.Plots.resize('plotly-posterior-lc-chart');
    });
});
</script>
{% endblock %}
